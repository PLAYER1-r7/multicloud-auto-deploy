name: Deploy Frontend Web (React SPA) to AWS

on:
  push:
    branches:
      - develop # stagingËá™Âãï„Éá„Éó„É≠„Ç§
      - main # productionËá™Âãï„Éá„Éó„É≠„Ç§
    paths:
      - "services/frontend_react/**"
      - ".github/workflows/deploy-frontend-web-aws.yml"
  workflow_dispatch:
    inputs:
      environment:
        description: "Deployment environment"
        required: true
        default: "staging"
        type: choice
        options:
          - staging
          - production

env:
  AWS_REGION: ap-northeast-1
  NODE_VERSION: "20"
  PULUMI_PYTHON_VERSION: "3.13"

concurrency:
  group: deploy-frontend-web-aws-${{ github.event_name == 'workflow_dispatch' && github.event.inputs.environment || (github.ref == 'refs/heads/main' && 'production' || 'staging') }}
  cancel-in-progress: false

jobs:
  deploy:
    name: Build & Deploy React SPA to S3/CloudFront
    runs-on: ubuntu-latest
    environment: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.environment || (github.ref == 'refs/heads/main' && 'production' || 'staging') }}

    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Determine environment
        id: env
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            ENV="${{ github.event.inputs.environment }}"
          elif [ "${{ github.ref }}" == "refs/heads/main" ]; then
            ENV="production"
          else
            ENV="staging"
          fi
          echo "env_name=$ENV" >> $GITHUB_OUTPUT
          echo "üì¶ Deploying to: $ENV"

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Python (Pulumi)
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PULUMI_PYTHON_VERSION }}

      - name: Install Pulumi CLI
        uses: pulumi/actions@v5

      - name: Install Pulumi Python Dependencies
        run: |
          cd infrastructure/pulumi/aws
          pip install -r requirements.txt

      - name: Get Pulumi Outputs
        id: pulumi
        run: |
          cd infrastructure/pulumi/aws
          STACK="${{ steps.env.outputs.env_name }}"
          pulumi login
          pulumi stack select "$STACK"
          echo "api_url=$(pulumi stack output api_gateway_endpoint)"         >> $GITHUB_OUTPUT
          echo "bucket=$(pulumi stack output frontend_bucket_name)"          >> $GITHUB_OUTPUT
          echo "cf_id=$(pulumi stack output cloudfront_distribution_id)"     >> $GITHUB_OUTPUT
          echo "cf_domain=$(pulumi stack output cloudfront_domain)"          >> $GITHUB_OUTPUT
          echo "cognito_domain=$(pulumi stack output cognito_domain)"        >> $GITHUB_OUTPUT
          echo "cognito_client_id=$(pulumi stack output cognito_client_id)"  >> $GITHUB_OUTPUT
          echo "user_pool_id=$(pulumi stack output cognito_user_pool_id)"    >> $GITHUB_OUTPUT
          echo "custom_domain=$(pulumi stack output custom_domain 2>/dev/null || echo '')" >> $GITHUB_OUTPUT
        env:
          PULUMI_ACCESS_TOKEN: ${{ secrets.PULUMI_ACCESS_TOKEN }}
          AWS_REGION: ${{ env.AWS_REGION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm
          cache-dependency-path: services/frontend_react/package-lock.json

      - name: Install dependencies
        working-directory: services/frontend_react
        run: npm ci

      - name: Build React SPA
        working-directory: services/frontend_react
        env:
          VITE_BASE_PATH: /sns/
          VITE_API_URL: ${{ steps.pulumi.outputs.api_url }}
          VITE_AUTH_PROVIDER: aws
          # Cognito hosted UI domain (e.g. simple-sns-production.auth.ap-northeast-1.amazoncognito.com)
          VITE_COGNITO_DOMAIN: ${{ steps.pulumi.outputs.cognito_domain }}.auth.${{ env.AWS_REGION }}.amazoncognito.com
          VITE_COGNITO_CLIENT_ID: ${{ steps.pulumi.outputs.cognito_client_id }}
          # „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØÁî®: window.location.origin „ÅßÂãïÁöÑ„Å´‰∏äÊõ∏„Åç„Åï„Çå„Çã„Åü„ÇÅ CloudFront URL „ÅßËâØ„ÅÑ
          VITE_COGNITO_REDIRECT_URI: https://${{ steps.pulumi.outputs.cf_domain }}/sns/auth/callback
          VITE_COGNITO_LOGOUT_URI: https://${{ steps.pulumi.outputs.cf_domain }}/sns/
        run: |
          npm run build
          echo "‚úÖ Build complete ($(du -sh dist | cut -f1))"

      - name: Deploy to S3
        run: |
          BUCKET="${{ steps.pulumi.outputs.bucket }}"
          aws s3 sync services/frontend_react/dist/ s3://${BUCKET}/sns/ \
            --delete \
            --cache-control "public, max-age=31536000, immutable" \
            --exclude "index.html"
          # index.html „ÅØÁü≠„ÅÑ„Ç≠„É£„ÉÉ„Ç∑„É•
          aws s3 cp services/frontend_react/dist/index.html \
            s3://${BUCKET}/sns/index.html \
            --cache-control "public, max-age=300" \
            --content-type "text/html"
          echo "‚úÖ Deployed to s3://${BUCKET}/sns/"

      - name: Update Cognito Callback URLs
        run: |
          CF_DOMAIN="${{ steps.pulumi.outputs.cf_domain }}"
          CUSTOM_DOMAIN="${{ steps.pulumi.outputs.custom_domain }}"
          USER_POOL_ID="${{ steps.pulumi.outputs.user_pool_id }}"
          CLIENT_ID="${{ steps.pulumi.outputs.cognito_client_id }}"

          # „Éô„Éº„Çπ URL „É™„Çπ„Éà (Â∏∏„Å´Âê´„ÇÅ„Çã)
          CALLBACK_URLS="http://localhost:8080/callback https://localhost:8080/callback http://localhost:5173/sns/auth/callback https://${CF_DOMAIN}/sns/auth/callback"
          LOGOUT_URLS="http://localhost:8080/ https://localhost:8080/ http://localhost:5173/sns/ https://${CF_DOMAIN}/sns/"

          # „Ç´„Çπ„Çø„É†„Éâ„É°„Ç§„É≥„ÅåË®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÅØËøΩÂä†
          if [[ -n "$CUSTOM_DOMAIN" ]]; then
            CALLBACK_URLS="$CALLBACK_URLS https://${CUSTOM_DOMAIN}/sns/auth/callback"
            LOGOUT_URLS="$LOGOUT_URLS https://${CUSTOM_DOMAIN}/sns/"
            echo "üåê Custom domain callback URLs added: https://${CUSTOM_DOMAIN}/sns/auth/callback"
          fi

          aws cognito-idp update-user-pool-client \
            --user-pool-id "$USER_POOL_ID" \
            --client-id "$CLIENT_ID" \
            --region ${{ env.AWS_REGION }} \
            --supported-identity-providers "COGNITO" \
            --allowed-o-auth-flows "code" "implicit" \
            --allowed-o-auth-scopes "email" "openid" "profile" \
            --allowed-o-auth-flows-user-pool-client \
            --callback-urls $CALLBACK_URLS \
            --logout-urls $LOGOUT_URLS \
            --no-cli-pager
          echo "‚úÖ Cognito callback URLs updated"

      - name: Invalidate CloudFront Cache
        run: |
          CF_ID="${{ steps.pulumi.outputs.cf_id }}"
          aws cloudfront create-invalidation \
            --distribution-id "$CF_ID" \
            --paths "/sns*" \
            --no-cli-pager
          echo "‚úÖ Invalidation issued for /sns*"

      - name: Deployment Summary
        run: |
          echo "‚úÖ Deployed to: https://${{ steps.pulumi.outputs.cf_domain }}/sns/"
          if [[ -n "${{ steps.pulumi.outputs.custom_domain }}" ]]; then
            echo "   Custom Domain: https://${{ steps.pulumi.outputs.custom_domain }}/sns/"
          fi
          echo "   API URL   : ${{ steps.pulumi.outputs.api_url }}"
          echo "   S3 Bucket : ${{ steps.pulumi.outputs.bucket }}/sns/"
