name: Deploy to Multi-Cloud (Azure & GCP)

on:
  push:
    branches: [main]
    paths:
      - "services/**"
      - ".github/workflows/deploy-multicloud.yml"
  workflow_dispatch:
    inputs:
      environment:
        description: "Deployment environment"
        required: true
        default: "staging"
        type: choice
        options:
          - staging
          - production
      deploy_target:
        description: "Deployment target"
        required: true
        default: "all"
        type: choice
        options:
          - all
          - azure
          - gcp

env:
  AZURE_REGION: japaneast
  GCP_REGION: asia-northeast1
  PYTHON_VERSION: "3.12"

jobs:
  build-images:
    name: Build Docker Images
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment || 'staging' }}
    outputs:
      git_sha: ${{ steps.get_sha.outputs.sha }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Get Git SHA
        id: get_sha
        run: echo "sha=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Log in to Azure Container Registry
        if: github.event.inputs.deploy_target != 'gcp'
        uses: docker/login-action@v3
        with:
          registry: ${{ secrets.AZURE_CONTAINER_REGISTRY }}
          username: ${{ secrets.AZURE_CONTAINER_REGISTRY_USERNAME }}
          password: ${{ secrets.AZURE_CONTAINER_REGISTRY_PASSWORD }}
      
      - name: Authenticate to Google Cloud
        if: github.event.inputs.deploy_target != 'azure'
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_CREDENTIALS }}
      
      - name: Configure Docker for GCP
        if: github.event.inputs.deploy_target != 'azure'
        run: |
          gcloud auth configure-docker ${{ env.GCP_REGION }}-docker.pkg.dev
      
      - name: Build and push API image
        uses: docker/build-push-action@v5
        with:
          context: ./services/api
          file: ./services/api/Dockerfile
          platforms: linux/amd64
          push: true
          tags: |
            ${{ secrets.AZURE_CONTAINER_REGISTRY }}/multicloud-auto-deploy-api:latest
            ${{ secrets.AZURE_CONTAINER_REGISTRY }}/multicloud-auto-deploy-api:${{ steps.get_sha.outputs.sha }}
            ${{ env.GCP_REGION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/${{ secrets.GCP_ARTIFACT_REGISTRY_REPO }}/multicloud-auto-deploy-api:latest
            ${{ env.GCP_REGION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/${{ secrets.GCP_ARTIFACT_REGISTRY_REPO }}/multicloud-auto-deploy-api:${{ steps.get_sha.outputs.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
      
      - name: Build and push Frontend image
        uses: docker/build-push-action@v5
        with:
          context: ./services/frontend_reflex
          file: ./services/frontend_reflex/Dockerfile
          platforms: linux/amd64
          push: true
          tags: |
            ${{ secrets.AZURE_CONTAINER_REGISTRY }}/multicloud-auto-deploy-frontend:latest
            ${{ secrets.AZURE_CONTAINER_REGISTRY }}/multicloud-auto-deploy-frontend:${{ steps.get_sha.outputs.sha }}
            ${{ env.GCP_REGION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/${{ secrets.GCP_ARTIFACT_REGISTRY_REPO }}/multicloud-auto-deploy-frontend:latest
            ${{ env.GCP_REGION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/${{ secrets.GCP_ARTIFACT_REGISTRY_REPO }}/multicloud-auto-deploy-frontend:${{ steps.get_sha.outputs.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  deploy-azure:
    name: Deploy to Azure Container Apps
    runs-on: ubuntu-latest
    needs: build-images
    if: |
      github.event.inputs.deploy_target == 'all' || 
      github.event.inputs.deploy_target == 'azure' ||
      github.event.inputs.deploy_target == null
    environment: ${{ github.event.inputs.environment || 'staging' }}
    
    steps:
      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
      
      - name: Deploy API to Azure Container Apps
        run: |
          az containerapp update \
            --name ${{ secrets.AZURE_CONTAINER_APP_API }} \
            --resource-group ${{ secrets.AZURE_RESOURCE_GROUP }} \
            --image ${{ secrets.AZURE_CONTAINER_REGISTRY }}/multicloud-auto-deploy-api:${{ needs.build-images.outputs.git_sha }}
      
      - name: Deploy Frontend to Azure Container Apps
        run: |
          az containerapp update \
            --name ${{ secrets.AZURE_CONTAINER_APP_FRONTEND }} \
            --resource-group ${{ secrets.AZURE_RESOURCE_GROUP }} \
            --image ${{ secrets.AZURE_CONTAINER_REGISTRY }}/multicloud-auto-deploy-frontend:${{ needs.build-images.outputs.git_sha }}
      
      - name: Get Azure Container App URLs
        id: azure_urls
        run: |
          API_URL=$(az containerapp show \
            --name ${{ secrets.AZURE_CONTAINER_APP_API }} \
            --resource-group ${{ secrets.AZURE_RESOURCE_GROUP }} \
            --query "properties.configuration.ingress.fqdn" -o tsv)
          
          FRONTEND_URL=$(az containerapp show \
            --name ${{ secrets.AZURE_CONTAINER_APP_FRONTEND }} \
            --resource-group ${{ secrets.AZURE_RESOURCE_GROUP }} \
            --query "properties.configuration.ingress.fqdn" -o tsv)
          
          echo "api_url=https://$API_URL" >> $GITHUB_OUTPUT
          echo "frontend_url=https://$FRONTEND_URL" >> $GITHUB_OUTPUT
          
          echo "### Azure Deployment Complete ðŸŽ‰" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **API**: https://$API_URL" >> $GITHUB_STEP_SUMMARY
          echo "- **Frontend**: https://$FRONTEND_URL" >> $GITHUB_STEP_SUMMARY

  deploy-gcp:
    name: Deploy to GCP Cloud Run
    runs-on: ubuntu-latest
    needs: build-images
    if: |
      github.event.inputs.deploy_target == 'all' || 
      github.event.inputs.deploy_target == 'gcp' ||
      github.event.inputs.deploy_target == null
    environment: ${{ github.event.inputs.environment || 'staging' }}
    
    steps:
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_CREDENTIALS }}
      
      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}
      
      - name: Deploy API to Cloud Run
        run: |
          gcloud run deploy ${{ secrets.GCP_CLOUD_RUN_API }} \
            --image ${{ env.GCP_REGION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/${{ secrets.GCP_ARTIFACT_REGISTRY_REPO }}/multicloud-auto-deploy-api:${{ needs.build-images.outputs.git_sha }} \
            --region ${{ env.GCP_REGION }} \
            --platform managed \
            --allow-unauthenticated \
            --port 8000 \
            --cpu 1 \
            --memory 1Gi \
            --min-instances 1 \
            --max-instances 10
      
      - name: Deploy Frontend to Cloud Run
        run: |
          gcloud run deploy ${{ secrets.GCP_CLOUD_RUN_FRONTEND }} \
            --image ${{ env.GCP_REGION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/${{ secrets.GCP_ARTIFACT_REGISTRY_REPO }}/multicloud-auto-deploy-frontend:${{ needs.build-images.outputs.git_sha }} \
            --region ${{ env.GCP_REGION }} \
            --platform managed \
            --allow-unauthenticated \
            --port 3002 \
            --cpu 2 \
            --memory 2Gi \
            --min-instances 1 \
            --max-instances 5 \
            --timeout 300 \
            --cpu-boost
      
      - name: Get GCP Cloud Run URLs
        id: gcp_urls
        run: |
          API_URL=$(gcloud run services describe ${{ secrets.GCP_CLOUD_RUN_API }} \
            --region ${{ env.GCP_REGION }} \
            --format="value(status.url)")
          
          FRONTEND_URL=$(gcloud run services describe ${{ secrets.GCP_CLOUD_RUN_FRONTEND }} \
            --region ${{ env.GCP_REGION }} \
            --format="value(status.url)")
          
          echo "api_url=$API_URL" >> $GITHUB_OUTPUT
          echo "frontend_url=$FRONTEND_URL" >> $GITHUB_OUTPUT
          
          echo "### GCP Deployment Complete ðŸŽ‰" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **API**: $API_URL" >> $GITHUB_STEP_SUMMARY
          echo "- **Frontend**: $FRONTEND_URL" >> $GITHUB_STEP_SUMMARY

  health-check:
    name: Health Check
    runs-on: ubuntu-latest
    needs: [deploy-azure, deploy-gcp]
    if: always() && (needs.deploy-azure.result == 'success' || needs.deploy-gcp.result == 'success')
    
    steps:
      - name: Check Azure API Health
        if: needs.deploy-azure.result == 'success'
        run: |
          for i in {1..5}; do
            if curl -f -s "${{ needs.deploy-azure.outputs.api_url }}/health"; then
              echo "âœ… Azure API health check passed"
              exit 0
            fi
            echo "â³ Waiting for Azure API to be ready (attempt $i/5)..."
            sleep 10
          done
          echo "âŒ Azure API health check failed"
          exit 1
      
      - name: Check GCP API Health
        if: needs.deploy-gcp.result == 'success'
        run: |
          for i in {1..5}; do
            if curl -f -s "${{ needs.deploy-gcp.outputs.api_url }}/health"; then
              echo "âœ… GCP API health check passed"
              exit 0
            fi
            echo "â³ Waiting for GCP API to be ready (attempt $i/5)..."
            sleep 10
          done
          echo "âŒ GCP API health check failed"
          exit 1
      
      - name: Deployment Summary
        if: always()
        run: |
          echo "### ðŸŒ Multi-Cloud Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Git SHA**: ${{ needs.build-images.outputs.git_sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Status**:" >> $GITHUB_STEP_SUMMARY
          echo "- Azure: ${{ needs.deploy-azure.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- GCP: ${{ needs.deploy-gcp.result }}" >> $GITHUB_STEP_SUMMARY
