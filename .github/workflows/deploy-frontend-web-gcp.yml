name: Deploy Frontend Web (React SPA) to GCP

on:
  push:
    branches:
      - develop # stagingè‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤
      - main # productionè‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤
    paths:
      - "services/frontend_react/**"
      - ".github/workflows/deploy-frontend-web-gcp.yml"
  workflow_dispatch:
    inputs:
      environment:
        description: "Deployment environment"
        required: true
        default: "staging"
        type: choice
        options:
          - staging
          - production

env:
  GCP_REGION: asia-northeast1
  NODE_VERSION: "20"

concurrency:
  group: deploy-frontend-web-gcp-${{ github.event_name == 'workflow_dispatch' && github.event.inputs.environment || (github.ref == 'refs/heads/main' && 'production' || 'staging') }}
  cancel-in-progress: false

jobs:
  deploy:
    name: Build & Deploy React SPA to GCS/Cloud CDN
    runs-on: ubuntu-latest
    environment: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.environment || (github.ref == 'refs/heads/main' && 'production' || 'staging') }}

    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Determine environment
        id: env
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            ENV="${{ github.event.inputs.environment }}"
          elif [ "${{ github.ref }}" == "refs/heads/main" ]; then
            ENV="production"
          else
            ENV="staging"
          fi
          echo "env_name=$ENV" >> $GITHUB_OUTPUT
          # GCS bucket follows predictable naming convention
          PROJECT_ID="${{ secrets.GCP_PROJECT_ID }}"
          echo "bucket=${PROJECT_ID}-multicloud-auto-deploy-${ENV}-frontend" >> $GITHUB_OUTPUT
          # staging uses EXTERNAL_MANAGED LB (urlmap-v2); production uses classic LB (urlmap)
          if [ "$ENV" = "staging" ]; then
            echo "urlmap=multicloud-auto-deploy-${ENV}-cdn-urlmap-v2"        >> $GITHUB_OUTPUT
          else
            echo "urlmap=multicloud-auto-deploy-${ENV}-cdn-urlmap"           >> $GITHUB_OUTPUT
          fi
          echo "ðŸ“¦ Deploying to: $ENV"

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_CREDENTIALS }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm
          cache-dependency-path: services/frontend_react/package-lock.json

      - name: Install dependencies
        working-directory: services/frontend_react
        run: npm ci

      - name: Build React SPA
        working-directory: services/frontend_react
        env:
          VITE_BASE_PATH: /sns/
          # GCP_API_ENDPOINT secret: e.g. https://multicloud-auto-deploy-staging-api-xxxx-an.a.run.app
          VITE_API_URL: ${{ secrets.GCP_API_ENDPOINT }}
          VITE_AUTH_PROVIDER: firebase
          VITE_FIREBASE_API_KEY: ${{ secrets.FIREBASE_API_KEY }}
          VITE_FIREBASE_AUTH_DOMAIN: ${{ secrets.FIREBASE_AUTH_DOMAIN }}
          VITE_FIREBASE_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
          VITE_FIREBASE_APP_ID: ${{ secrets.FIREBASE_APP_ID }}
        run: |
          npm run build
          echo "âœ… Build complete ($(du -sh dist | cut -f1))"

      - name: Deploy to GCS
        run: |
          BUCKET="${{ steps.env.outputs.bucket }}"

          # assets (immutable long-lived cache)
          gsutil -m -h "Cache-Control:public, max-age=31536000, immutable" \
            cp -r services/frontend_react/dist/assets "gs://${BUCKET}/sns/"

          # index.html (short cache)
          gsutil -h "Cache-Control:public, max-age=300" \
            -h "Content-Type:text/html" \
            cp services/frontend_react/dist/index.html "gs://${BUCKET}/sns/index.html"

          # svgã‚¢ã‚¤ã‚³ãƒ³
          gsutil -m -h "Cache-Control:public, max-age=3600" \
            cp services/frontend_react/dist/vite.svg "gs://${BUCKET}/sns/vite.svg" 2>/dev/null || true

          echo "âœ… Deployed to gs://${BUCKET}/sns/"

      - name: Invalidate Cloud CDN Cache
        run: |
          URLMAP="${{ steps.env.outputs.urlmap }}"
          gcloud compute url-maps invalidate-cdn-cache "$URLMAP" \
            --path "/sns/*" \
            --global \
            --async \
            --project "${{ secrets.GCP_PROJECT_ID }}"
          echo "âœ… CDN invalidation issued for /sns/*"

      - name: Deployment Summary
        run: |
          ENV="${{ steps.env.outputs.env_name }}"
          LB_IP=$(gcloud compute forwarding-rules list \
            --global \
            --filter="name~multicloud-auto-deploy-${ENV}-cdn-lb" \
            --format="value(IPAddress)" \
            --project "${{ secrets.GCP_PROJECT_ID }}" 2>/dev/null | head -1 || echo "(see GCP console)")
          echo "âœ… Deployed to: http://${LB_IP}/sns/"
          echo "   GCS Bucket : ${{ steps.env.outputs.bucket }}/sns/"
