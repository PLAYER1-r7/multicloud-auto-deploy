name: Deploy Frontend Web to Azure

on:
  push:
    branches:
      - develop # staging自動デプロイ
      - main # production自動デプロイ
    paths:
      - "multicloud-auto-deploy/services/frontend_web/**"
      - ".github/workflows/deploy-frontend-web-azure.yml"
  workflow_dispatch:
    inputs:
      environment:
        description: "Deployment environment"
        required: true
        default: "staging"
        type: choice
        options:
          - staging
          - production

env:
  PYTHON_VERSION: "3.12"

concurrency:
  group: deploy-frontend-web-azure-${{ github.event_name == 'workflow_dispatch' && github.event.inputs.environment || (github.ref == 'refs/heads/main' && 'production' || 'staging') }}
  cancel-in-progress: false

jobs:
  build:
    name: Build frontend_web for Azure Functions
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        working-directory: multicloud-auto-deploy/services/frontend_web
        run: pip install -r requirements.txt

      - name: Zip artifact
        working-directory: multicloud-auto-deploy/services/frontend_web
        run: zip -r release.zip app/ function_app.py host.json requirements.txt

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: frontend-web-app
          path: multicloud-auto-deploy/services/frontend_web/release.zip

  deploy:
    name: Deploy to Azure Functions
    runs-on: ubuntu-latest
    needs: build
    permissions:
      id-token: write
      contents: read

    steps:
      - name: Determine environment
        id: env
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            ENV="${{ github.event.inputs.environment }}"
          elif [ "${{ github.ref }}" == "refs/heads/main" ]; then
            ENV="production"
          else
            ENV="staging"
          fi
          echo "env_name=$ENV" >> $GITHUB_OUTPUT

      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: frontend-web-app

      - name: Unzip artifact
        run: unzip release.zip && rm release.zip

      - name: Login to Azure
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Deploy to Azure Functions
        uses: Azure/functions-action@v1
        with:
          app-name: multicloud-auto-deploy-${{ steps.env.outputs.env_name }}-frontend-web
          slot-name: Production
          package: .

      - name: Configure App Settings
        run: |
          az functionapp config appsettings set \
            --name multicloud-auto-deploy-${{ steps.env.outputs.env_name }}-frontend-web \
            --resource-group multicloud-auto-deploy-${{ steps.env.outputs.env_name }} \
            --settings STAGE_NAME=sns
          echo "✅ STAGE_NAME=sns configured"
