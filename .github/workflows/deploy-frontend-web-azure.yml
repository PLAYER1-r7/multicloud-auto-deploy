name: Deploy Frontend Web (React SPA) to Azure

on:
  push:
    branches:
      - develop # stagingè‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤
      - main # productionè‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤
    paths:
      - "services/frontend_react/**"
      - ".github/workflows/deploy-frontend-web-azure.yml"
  workflow_dispatch:
    inputs:
      environment:
        description: "Deployment environment"
        required: true
        default: "staging"
        type: choice
        options:
          - staging
          - production

env:
  NODE_VERSION: "20"

concurrency:
  group: deploy-frontend-web-azure-${{ github.event_name == 'workflow_dispatch' && github.event.inputs.environment || (github.ref == 'refs/heads/main' && 'production' || 'staging') }}
  cancel-in-progress: false

jobs:
  deploy:
    name: Build & Deploy React SPA to Azure Blob/AFD
    runs-on: ubuntu-latest
    environment: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.environment || (github.ref == 'refs/heads/main' && 'production' || 'staging') }}

    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Determine environment
        id: env
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            ENV="${{ github.event.inputs.environment }}"
          elif [ "${{ github.ref }}" == "refs/heads/main" ]; then
            ENV="production"
          else
            ENV="staging"
          fi
          echo "env_name=$ENV" >> $GITHUB_OUTPUT

          # Blob storage accounts (fixed per environment)
          if [ "$ENV" == "staging" ]; then
            echo "storage_account=mcadwebd45ihd" >> $GITHUB_OUTPUT
          else
            echo "storage_account=mcadwebdiev0w" >> $GITHUB_OUTPUT
          fi

          echo "rg=multicloud-auto-deploy-${ENV}-rg"          >> $GITHUB_OUTPUT
          echo "afd_profile=multicloud-auto-deploy-${ENV}-fd"  >> $GITHUB_OUTPUT
          echo "ðŸ“¦ Deploying to: $ENV"

      - name: Login to Azure
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm
          cache-dependency-path: services/frontend_react/package-lock.json

      - name: Install dependencies
        working-directory: services/frontend_react
        run: npm ci

      - name: Build React SPA
        working-directory: services/frontend_react
        env:
          VITE_BASE_PATH: /sns/
          # Required secret: AZURE_API_ENDPOINT (per GitHub environment)
          # e.g. https://multicloud-auto-deploy-staging-api.azurewebsites.net
          VITE_API_URL: ${{ secrets.AZURE_API_ENDPOINT }}
        run: |
          npm run build
          echo "âœ… Build complete ($(du -sh dist | cut -f1))"

      - name: Deploy to Azure Blob Storage
        run: |
          STORAGE="${{ steps.env.outputs.storage_account }}"
          RG="${{ steps.env.outputs.rg }}"

          # ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚­ãƒ¼ã‚’å–å¾—ï¼ˆBlob Data ãƒ­ãƒ¼ãƒ«ä¸è¦ã€listKeysæ¨©é™ã§å¯èƒ½ï¼‰
          ACCOUNT_KEY=$(az storage account keys list \
            --account-name "$STORAGE" \
            --resource-group "$RG" \
            --query '[0].value' -o tsv)

          # assets (é•·æœŸã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ»immutable)
          az storage blob upload-batch \
            --account-name "$STORAGE" \
            --account-key "$ACCOUNT_KEY" \
            --destination '$web/sns' \
            --source services/frontend_react/dist/ \
            --pattern "assets/*" \
            --content-cache-control "public, max-age=31536000, immutable" \
            --overwrite true

          # index.html (çŸ­æœŸã‚­ãƒ£ãƒƒã‚·ãƒ¥)
          az storage blob upload-batch \
            --account-name "$STORAGE" \
            --account-key "$ACCOUNT_KEY" \
            --destination '$web/sns' \
            --source services/frontend_react/dist/ \
            --pattern "*.html" \
            --content-cache-control "public, max-age=300" \
            --content-type "text/html" \
            --overwrite true

          # ãã®ä»–ãƒ•ã‚¡ã‚¤ãƒ« (svgç­‰)
          az storage blob upload-batch \
            --account-name "$STORAGE" \
            --account-key "$ACCOUNT_KEY" \
            --destination '$web/sns' \
            --source services/frontend_react/dist/ \
            --pattern "*.svg" \
            --content-cache-control "public, max-age=3600" \
            --overwrite true

          echo "âœ… Deployed to blob: ${STORAGE}/\$web/sns/"

      - name: Purge AFD Cache
        run: |
          RG="${{ steps.env.outputs.rg }}"
          PROFILE="${{ steps.env.outputs.afd_profile }}"
          ENDPOINT=$(az afd endpoint list \
            --profile-name "$PROFILE" \
            --resource-group "$RG" \
            --query '[0].name' -o tsv)
          if [ -z "$ENDPOINT" ]; then
            echo "âš ï¸ AFD endpoint not found, skipping purge"
            exit 0
          fi
          HOSTNAME=$(az afd endpoint show \
            --profile-name "$PROFILE" \
            --resource-group "$RG" \
            --endpoint-name "$ENDPOINT" \
            --query 'hostName' -o tsv)
          az afd endpoint purge \
            --profile-name "$PROFILE" \
            --resource-group "$RG" \
            --endpoint-name "$ENDPOINT" \
            --content-paths '/sns' '/sns/' '/sns/*' \
            --domains "$HOSTNAME"
          echo "âœ… AFD cache purged for /sns*"

      - name: Deployment Summary
        run: |
          RG="${{ steps.env.outputs.rg }}"
          PROFILE="${{ steps.env.outputs.afd_profile }}"
          HOSTNAME=$(az afd endpoint list \
            --profile-name "$PROFILE" \
            --resource-group "$RG" \
            --query '[0].hostName' -o tsv 2>/dev/null || echo "(see AFD portal)")
          echo "âœ… Deployed to: https://${HOSTNAME}/sns/"
          echo "   Blob Storage: ${{ steps.env.outputs.storage_account }}/\$web/sns/"
