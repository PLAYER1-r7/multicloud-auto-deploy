name: Deploy to GCP

on:
  push:
    branches: [main]
    paths:
      - "services/**"
      - "infrastructure/terraform/gcp/**"
      - ".github/workflows/deploy-gcp.yml"
  workflow_dispatch:
    inputs:
      environment:
        description: "Deployment environment"
        required: true
        default: "staging"
        type: choice
        options:
          - staging
          - production

env:
  GCP_REGION: asia-northeast1
  NODE_VERSION: "18"
  PYTHON_VERSION: "3.11"

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment || 'staging' }}

    steps:
      - uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_CREDENTIALS }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.7.5
          terraform_wrapper: false

      - name: Deploy Infrastructure
        run: |
          cd infrastructure/terraform/gcp
          terraform init
          
          # Try to import existing resources
          echo "==========================================="
          echo "Starting resource import phase..."
          echo "==========================================="
          
          ENVIRONMENT="${{ github.event.inputs.environment || 'staging' }}"
          PROJECT_ID="${{ secrets.GCP_PROJECT_ID }}"
          REGION="asia-northeast1"
          PREFIX="multicloud-auto-deploy-${ENVIRONMENT}"
          
          echo "Environment: $ENVIRONMENT"
          echo "Project ID: $PROJECT_ID"
          echo "Region: $REGION"
          echo "Prefix: $PREFIX"
          echo ""
          
          # Function to import resource
          import_resource() {
            local resource_type=$1
            local resource_name=$2
            local resource_id=$3
            
            echo "-------------------------------------------"
            echo "Processing: $resource_type.$resource_name"
            echo "Resource ID: $resource_id"
            
            # Check if already in state
            echo "Checking if resource is in state..."
            if terraform state show "$resource_type.$resource_name" >/dev/null 2>&1; then
              echo "✓ Resource already in state - skipping import"
              return 0
            fi
            
            echo "→ Resource not in state - attempting import..."
            if terraform import \
              -var="project_id=${PROJECT_ID}" \
              -var="environment=${ENVIRONMENT}" \
              "$resource_type.$resource_name" \
              "$resource_id"; then
              echo "✓ Successfully imported"
              return 0
            else
              echo "✗ Import failed - resource may not exist yet (will be created)"
              return 1
            fi
          }
          
          # Import existing resources
          import_resource "google_artifact_registry_repository" "main" "projects/${PROJECT_ID}/locations/${REGION}/repositories/${PREFIX}-repo" || true
          import_resource "google_firestore_database" "main" "projects/${PROJECT_ID}/databases/(default)" || true
          import_resource "google_storage_bucket" "frontend" "${PREFIX}-frontend" || true
          import_resource "google_compute_global_address" "frontend" "projects/${PROJECT_ID}/global/addresses/${PREFIX}-frontend-ip" || true
          
          echo ""
          echo "==========================================="
          echo "Import phase completed"
          echo "==========================================="
          echo ""
          echo "Current terraform state:"
          terraform state list || echo "No resources in state yet"
          echo ""
          echo "==========================================="
          echo "Starting terraform plan..."
          echo "==========================================="
          
          terraform plan \
            -var="project_id=${{ secrets.GCP_PROJECT_ID }}" \
            -var="environment=${{ github.event.inputs.environment || 'staging' }}"
          
          echo ""
          echo "==========================================="
          echo "Starting terraform apply..."
          echo "==========================================="
          
          terraform apply \
            -var="project_id=${{ secrets.GCP_PROJECT_ID }}" \
            -var="environment=${{ github.event.inputs.environment || 'staging' }}" \
            -auto-approve

      - name: Build and Push Docker Image
        run: |
          cd services/backend

          # Get Artifact Registry repo from Terraform output
          cd ../../infrastructure/terraform/gcp
          PROJECT_ID=${{ secrets.GCP_PROJECT_ID }}
          REPO_LOCATION=$(terraform output -raw artifact_registry_location || echo "asia-northeast1")
          REPO_NAME=$(terraform output -raw artifact_registry_repo)

          # Configure Docker for Artifact Registry
          gcloud auth configure-docker ${REPO_LOCATION}-docker.pkg.dev

          # Build and push Docker image
          cd ../../../services/backend
          IMAGE_URI="${REPO_LOCATION}-docker.pkg.dev/${PROJECT_ID}/${REPO_NAME}/multicloud-auto-deploy-api:latest"
          docker build --platform linux/amd64 \
            -t $IMAGE_URI \
            -f Dockerfile.gcp .
          docker push $IMAGE_URI

      - name: Deploy Cloud Run Service
        run: |
          cd infrastructure/terraform/gcp

          # Re-apply Terraform to update Cloud Run with new image
          terraform apply \
            -var="project_id=${{ secrets.GCP_PROJECT_ID }}" \
            -var="environment=${{ github.event.inputs.environment || 'staging' }}" \
            -auto-approve

          # Get Cloud Run service name
          SERVICE_NAME=$(terraform output -raw cloud_run_service_name)

          # Set IAM policy for public access
          gcloud run services add-iam-policy-binding $SERVICE_NAME \
            --region=${{ env.GCP_REGION }} \
            --member="allUsers" \
            --role="roles/run.invoker" || true

      - name: Build Frontend
        run: |
          cd infrastructure/terraform/gcp
          API_URL=$(terraform output -raw api_url)

          cd ../../services/frontend
          npm install
          VITE_API_URL=$API_URL npm run build

      - name: Deploy Frontend to Cloud Storage
        run: |
          cd infrastructure/terraform/gcp
          BUCKET_NAME=$(terraform output -raw frontend_bucket_name)

          # Upload frontend to Cloud Storage
          gsutil -m cp -r ../../services/frontend/dist/* gs://$BUCKET_NAME/

          # Make objects public
          gsutil -m acl ch -u AllUsers:R gs://$BUCKET_NAME/** || true

      - name: Notify Success
        if: success()
        run: echo "✅ GCP deployment succeeded!"

      - name: Notify Failure
        if: failure()
        run: echo "❌ GCP deployment failed!"
