name: Deploy to GCP

on:
  push:
    branches: [main]
    paths:
      - "services/**"
      - "infrastructure/terraform/gcp/**"
      - ".github/workflows/deploy-gcp.yml"
  workflow_dispatch:
    inputs:
      environment:
        description: "Deployment environment"
        required: true
        default: "staging"
        type: choice
        options:
          - staging
          - production

env:
  GCP_REGION: asia-northeast1
  NODE_VERSION: "18"
  PYTHON_VERSION: "3.11"

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment || 'staging' }}

    steps:
      - uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_CREDENTIALS }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.7.5
          terraform_wrapper: false

      - name: Deploy Infrastructure
        id: terraform
        run: |
          cd infrastructure/terraform/gcp
          
          echo "==========================================="
          echo "Initializing Terraform with GCS backend..."
          echo "==========================================="
          terraform init
          
          echo ""
          echo "Checking current state..."
          terraform state list || echo "No resources in state yet"
          
          echo ""
          echo "==========================================="
          echo "Planning infrastructure changes..."
          echo "==========================================="
          terraform plan \
            -var="project_id=${{ secrets.GCP_PROJECT_ID }}" \
            -var="environment=${{ github.event.inputs.environment || 'staging' }}"
          
          echo ""
          echo "==========================================="
          echo "Applying infrastructure changes..."
          echo "==========================================="
          terraform apply \
            -var="project_id=${{ secrets.GCP_PROJECT_ID }}" \
            -var="environment=${{ github.event.inputs.environment || 'staging' }}" \
            -auto-approve
          
          # Extract Terraform outputs for later use
          echo "repo_location=$(terraform output -raw artifact_registry_location)" >> $GITHUB_OUTPUT
          echo "repo_name=$(terraform output -raw artifact_registry_repo)" >> $GITHUB_OUTPUT
          echo "service_name=$(terraform output -raw cloud_run_service_name)" >> $GITHUB_OUTPUT
          echo "storage_bucket=$(terraform output -raw frontend_storage_bucket)" >> $GITHUB_OUTPUT
          echo "api_url=$(terraform output -raw api_url)" >> $GITHUB_OUTPUT

      - name: Build and Push Docker Image
        run: |
          # Use values from Terraform output (stored in previous step)
          PROJECT_ID=${{ secrets.GCP_PROJECT_ID }}
          REPO_LOCATION="${{ steps.terraform.outputs.repo_location }}"
          REPO_NAME="${{ steps.terraform.outputs.repo_name }}"

          echo "Building and pushing Docker image..."
          echo "  Project: $PROJECT_ID"
          echo "  Location: $REPO_LOCATION"
          echo "  Repository: $REPO_NAME"

          # Configure Docker for Artifact Registry
          gcloud auth configure-docker ${REPO_LOCATION}-docker.pkg.dev

          # Build and push Docker image
          cd services/api
          IMAGE_URI="${REPO_LOCATION}-docker.pkg.dev/${PROJECT_ID}/${REPO_NAME}/multicloud-auto-deploy-api:latest"
          docker build --platform linux/amd64 \
            -t $IMAGE_URI \
            -f Dockerfile .
          docker push $IMAGE_URI

      - name: Deploy Cloud Run Service
        run: |
          # Use service name from Terraform output
          SERVICE_NAME="${{ steps.terraform.outputs.service_name }}"
          
          echo "Setting IAM policy for Cloud Run service: $SERVICE_NAME"

          # Set IAM policy for public access
          gcloud run services add-iam-policy-binding $SERVICE_NAME \
            --region=${{ env.GCP_REGION }} \
            --member="allUsers" \
            --role="roles/run.invoker" || true

      - name: Build Frontend
        run: |
          # Use API URL from Terraform output
          API_URL="${{ steps.terraform.outputs.api_url }}"
          
          echo "Building frontend with API URL: $API_URL"

          cd services/frontend_react
          npm install
          VITE_API_URL=$API_URL npm run build

      - name: Deploy Frontend to Cloud Storage
        run: |
          # Use bucket name from Terraform output
          BUCKET_NAME="${{ steps.terraform.outputs.storage_bucket }}"
          
          echo "Deploying frontend to bucket: $BUCKET_NAME"

          # Upload frontend to Cloud Storage
          gsutil -m cp -r services/frontend_react/dist/* gs://$BUCKET_NAME/

          # Make objects public
          gsutil -m acl ch -u AllUsers:R gs://$BUCKET_NAME/** || true

      - name: Notify Success
        if: success()
        run: echo "✅ GCP deployment succeeded!"

      - name: Notify Failure
        if: failure()
        run: echo "❌ GCP deployment failed!"
