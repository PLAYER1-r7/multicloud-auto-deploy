name: Deploy to AWS

on:
  push:
    branches: [main]
    paths:
      - "services/**"
      - "infrastructure/terraform/aws/**"
      - ".github/workflows/deploy-aws.yml"
  workflow_dispatch:
    inputs:
      environment:
        description: "Deployment environment"
        required: true
        default: "staging"
        type: choice
        options:
          - staging
          - production

env:
  AWS_REGION: ap-northeast-1
  NODE_VERSION: "18"
  PYTHON_VERSION: "3.12"

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment || 'staging' }}

    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Package Backend
        run: |
          cd services/api
          rm -rf package lambda.zip
          mkdir -p package
          
          # AWS LambdaÁî®„ÅÆÊúÄÂ∞èÈôê„ÅÆ‰æùÂ≠òÈñ¢‰øÇ„ÅÆ„Åø„Ç§„É≥„Çπ„Éà„Éº„É´Ôºàboto3„ÅØLambdaÁí∞Â¢É„Å´Âê´„Åæ„Çå„Å¶„ÅÑ„ÇãÔºâ
          echo "üì¶ Installing dependencies..."
          pip install --platform manylinux2014_x86_64 --only-binary=:all: \
            --target package --python-version 3.12 --implementation cp \
            fastapi==0.109.0 pydantic==2.5.3 python-dotenv==1.0.0 mangum==0.17.0
          
          # Copy source code
          echo "üìÅ Copying source code..."
          cp -r src/* package/
          
          # Create zip
          echo "üóúÔ∏è  Creating lambda package..."
          cd package
          zip -r ../lambda.zip .
          cd ..
          
          # Show package info
          echo "‚úÖ Package created:"
          ls -lh lambda.zip

      - name: Update Lambda Function
        id: update_lambda
        run: |
          set -e  # Exit on error
          LAMBDA_FUNCTION=${{ secrets.AWS_LAMBDA_FUNCTION_NAME || 'multicloud-auto-deploy-staging-api' }}
          S3_BUCKET=${{ secrets.AWS_S3_BUCKET || 'multicloud-auto-deploy-staging-frontend' }}
          S3_KEY="lambda-deployments/lambda-$(date +%Y%m%d-%H%M%S).zip"
          
          # Debug: Check lambda.zip exists and show size
          echo "üì¶ Checking lambda.zip..."
          ls -lh services/api/lambda.zip || { echo "‚ùå lambda.zip not found!"; exit 1; }
          
          # Upload to S3 first
          echo "‚òÅÔ∏è  Uploading to S3: s3://$S3_BUCKET/$S3_KEY"
          aws s3 cp services/api/lambda.zip s3://$S3_BUCKET/$S3_KEY || { echo "‚ùå S3 upload failed!"; exit 1; }
          
          # Update Lambda from S3
          echo "üöÄ Updating Lambda function: $LAMBDA_FUNCTION"
          aws lambda update-function-code \
            --function-name $LAMBDA_FUNCTION \
            --region ${{ env.AWS_REGION }} \
            --s3-bucket $S3_BUCKET \
            --s3-key $S3_KEY \
            --output json || { echo "‚ùå Lambda update failed!"; exit 1; }
          
          echo "‚úÖ Lambda function updated successfully"
          
          # Get API Gateway endpoint
          API_ID=$(aws apigatewayv2 get-apis --region ${{ env.AWS_REGION }} --query 'Items[?Name==`multicloud-auto-deploy-staging-api`].ApiId' --output text)
          if [ -n "$API_ID" ]; then
            API_ENDPOINT="https://${API_ID}.execute-api.${{ env.AWS_REGION }}.amazonaws.com"
            echo "api_endpoint=$API_ENDPOINT" >> $GITHUB_OUTPUT
            echo "‚úÖ API Endpoint: $API_ENDPOINT"
          else
            echo "‚ö†Ô∏è  API Gateway not found, using default"
            echo "api_endpoint=https://52z731x570.execute-api.ap-northeast-1.amazonaws.com" >> $GITHUB_OUTPUT
          fi

      - name: Build Frontend
        run: |
          cd services/frontend_react
          npm install
          npm run build
        env:
          VITE_API_URL: ${{ steps.update_lambda.outputs.api_endpoint }}

      - name: Deploy Frontend to S3
        run: |
          S3_BUCKET=${{ secrets.AWS_S3_BUCKET || 'multicloud-auto-deploy-staging-frontend' }}
          aws s3 sync services/frontend_react/dist/ s3://$S3_BUCKET/ --delete

      - name: Invalidate CloudFront Cache
        run: |
          CLOUDFRONT_ID=${{ secrets.AWS_CLOUDFRONT_ID || 'E2GDU7Y7UGDV3S' }}
          aws cloudfront create-invalidation \
            --distribution-id $CLOUDFRONT_ID \
            --paths "/*"

      - name: Notify Success
        if: success()
        run: echo "‚úÖ AWS deployment succeeded!"

      - name: Notify Failure
        if: failure()
        run: echo "‚ùå AWS deployment failed!"
