name: Deploy to AWS

on:
  push:
    branches: [main]
    paths:
      - "services/**"
      - "infrastructure/terraform/aws/**"
      - ".github/workflows/deploy-aws.yml"
  workflow_dispatch:
    inputs:
      environment:
        description: "Deployment environment"
        required: true
        default: "staging"
        type: choice
        options:
          - staging
          - production

env:
  AWS_REGION: ap-northeast-1
  NODE_VERSION: "18"
  PYTHON_VERSION: "3.12"

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment || 'staging' }}

    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Build Frontend
        run: |
          cd services/frontend
          npm install
          npm run build
        env:
          VITE_API_URL: ${{ secrets.AWS_API_URL || 'https://rnvg3bwzea.execute-api.us-east-1.amazonaws.com/prod' }}

      - name: Package Backend
        run: |
          cd services/backend
          mkdir -p package
          # AWS Lambda用の最小限の依存関係のみインストール（boto3はLambda環境に含まれている）
          pip install --platform manylinux2014_x86_64 --only-binary=:all: \
            --target package --python-version 3.12 --implementation cp \
            fastapi==0.109.0 pydantic==2.5.3 python-dotenv==1.0.0 mangum==0.17.0
          cp -r src/* package/
          cd package && zip -r ../lambda.zip . && cd ..

      - name: Update Lambda Function
        run: |
          LAMBDA_FUNCTION=${{ secrets.AWS_LAMBDA_FUNCTION_NAME || 'multicloud-auto-deploy-staging-api' }}
          S3_BUCKET=${{ secrets.AWS_S3_BUCKET || 'multicloud-auto-deploy-staging-frontend' }}
          S3_KEY="lambda-deployments/lambda-$(date +%Y%m%d-%H%M%S).zip"
          
          # Upload to S3 first (package is too large for direct upload)
          aws s3 cp services/backend/lambda.zip s3://$S3_BUCKET/$S3_KEY --region ${{ env.AWS_REGION }}
          
          # Update Lambda from S3
          aws lambda update-function-code \
            --function-name $LAMBDA_FUNCTION \
            --region ${{ env.AWS_REGION }} \
            --s3-bucket $S3_BUCKET \
            --s3-key $S3_KEY

      - name: Deploy Frontend to S3
        run: |
          S3_BUCKET=${{ secrets.AWS_S3_BUCKET || 'multicloud-auto-deploy-staging-frontend' }}
          aws s3 sync services/frontend/dist/ s3://$S3_BUCKET/ --delete

      - name: Invalidate CloudFront Cache
        run: |
          CLOUDFRONT_ID=${{ secrets.AWS_CLOUDFRONT_ID || 'E3ICZFV7XKB5O9' }}
          aws cloudfront create-invalidation \
            --distribution-id $CLOUDFRONT_ID \
            --paths "/*"

      - name: Notify Success
        if: success()
        run: echo "✅ AWS deployment succeeded!"

      - name: Notify Failure
        if: failure()
        run: echo "❌ AWS deployment failed!"
