name: Deploy to AWS

on:
  push:
    branches: [main]
    paths:
      - "services/**"
      - "infrastructure/pulumi/aws/**"
      - ".github/workflows/deploy-aws.yml"
  workflow_dispatch:
    inputs:
      environment:
        description: "Deployment environment"
        required: true
        default: "staging"
        type: choice
        options:
          - staging
          - production

env:
  AWS_REGION: ap-northeast-1
  NODE_VERSION: "18"
  PYTHON_VERSION: "3.12"

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment || 'staging' }}

    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Pulumi CLI
        uses: pulumi/actions@v5

      - name: Deploy Infrastructure with Pulumi
        id: pulumi
        uses: pulumi/actions@v5
        with:
          command: up
          stack-name: staging
          work-dir: infrastructure/pulumi/aws
        env:
          PULUMI_ACCESS_TOKEN: ${{ secrets.PULUMI_ACCESS_TOKEN }}
          AWS_REGION: ${{ env.AWS_REGION }}

      - name: Get Pulumi Outputs
        id: pulumi_outputs
        run: |
          cd infrastructure/pulumi/aws
          echo "lambda_function_name=$(pulumi stack output lambda_function_name)" >> $GITHUB_OUTPUT
          echo "api_gateway_endpoint=$(pulumi stack output api_gateway_endpoint)" >> $GITHUB_OUTPUT
          echo "frontend_bucket_name=$(pulumi stack output frontend_bucket_name)" >> $GITHUB_OUTPUT

      - name: Package Backend
        run: |
          cd services/api
          rm -rf package lambda.zip
          mkdir -p package
          
          # AWS Lambdaç”¨ã®æœ€å°é™ã®ä¾å­˜é–¢ä¿‚ã®ã¿ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼ˆboto3ã¯Lambdaç’°å¢ƒã«å«ã¾ã‚Œã¦ã„ã‚‹ï¼‰
          echo "ğŸ“¦ Installing dependencies..."
          pip install --platform manylinux2014_x86_64 --only-binary=:all: \
            --target package --python-version 3.12 --implementation cp \
            fastapi==0.109.0 pydantic==2.5.3 python-dotenv==1.0.0 mangum==0.17.0
          
          # Copy source code
          echo "ğŸ“ Copying source code..."
          cp -r app/* package/
          
          # Create handler.py for Lambda entry point
          cat > package/handler.py << 'EOF'
          from mangum import Mangum
          from app.main import app

          handler = Mangum(app, lifespan="off")
          EOF
          
          # Create zip
          echo "ğŸ—œï¸  Creating lambda package..."
          cd package
          zip -r ../lambda.zip .
          cd ..
          
          # Show package info
          echo "âœ… Package created:"
          ls -lh lambda.zip

      - name: Update Lambda Function
        id: update_lambda
        run: |
          set -e  # Exit on error
          LAMBDA_FUNCTION="${{ steps.pulumi_outputs.outputs.lambda_function_name }}"
          S3_BUCKET="${{ steps.pulumi_outputs.outputs.frontend_bucket_name }}"
          S3_KEY="lambda-deployments/lambda-$(date +%Y%m%d-%H%M%S).zip"
          
          # Debug: Check lambda.zip exists and show size
          echo "ğŸ“¦ Checking lambda.zip..."
          ls -lh services/api/lambda.zip || { echo "âŒ lambda.zip not found!"; exit 1; }
          
          # Upload to S3 first
          echo "â˜ï¸  Uploading to S3: s3://$S3_BUCKET/$S3_KEY"
          aws s3 cp services/api/lambda.zip s3://$S3_BUCKET/$S3_KEY || { echo "âŒ S3 upload failed!"; exit 1; }
          
          # Update Lambda from S3
          echo "ğŸš€ Updating Lambda function: $LAMBDA_FUNCTION"
          aws lambda update-function-code \
            --function-name $LAMBDA_FUNCTION \
            --region ${{ env.AWS_REGION }} \
            --s3-bucket $S3_BUCKET \
            --s3-key $S3_KEY \
            --output json || { echo "âŒ Lambda update failed!"; exit 1; }
          
          echo "âœ… Lambda function updated successfully"
          echo "api_endpoint=${{ steps.pulumi_outputs.outputs.api_gateway_endpoint }}" >> $GITHUB_OUTPUT

      - name: Build Frontend
        run: |
          cd services/frontend_react
          npm install
          npm run build
        env:
          VITE_API_URL: ${{ steps.update_lambda.outputs.api_endpoint }}

      - name: Deploy Frontend to S3
        run: |
          S3_BUCKET="${{ steps.pulumi_outputs.outputs.frontend_bucket_name }}"
          aws s3 sync services/frontend_react/dist/ s3://$S3_BUCKET/ --delete

      - name: Notify Success
        if: success()
        run: |
          echo "âœ… AWS deployment succeeded!"
          echo "ğŸ“ API Endpoint: ${{ steps.update_lambda.outputs.api_endpoint }}"
          echo "ğŸŒ Frontend: ${{ steps.pulumi_outputs.outputs.frontend_bucket_name }}"

      - name: Notify Failure
        if: failure()
        run: echo "âŒ AWS deployment failed!"
