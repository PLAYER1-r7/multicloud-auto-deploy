{% extends "base.html" %}
{% block title %}Login | Simple SNS{% endblock %}
{% block content %}
  <section class="panel">
    <h1>Login</h1>
    {% if auth_disabled %}
      <p>Local Development Mode - Enter any username</p>
      <form method="post" action="{{ base_path }}/login" class="form">
        <div class="form-group">
          <label for="username">Username</label>
          <input 
            type="text" 
            id="username" 
            name="username" 
            required 
            pattern="[a-zA-Z0-9_-]+" 
            placeholder="Enter username (alphanumeric, -, _)"
            autocomplete="username"
          />
          <small class="muted">Only alphanumeric characters, hyphens, and underscores are allowed.</small>
        </div>
        <div class="actions">
          <button type="submit" class="button">
            <svg class="icon" viewBox="0 0 24 24" aria-hidden="true">
              <path d="M7 10V7a5 5 0 0 1 10 0v3"></path>
              <rect x="4" y="10" width="16" height="10" rx="2"></rect>
            </svg>
            <span>Sign In</span>
          </button>
        </div>
      </form>
    {% elif firebase_config %}
      <p>Sign in with Firebase (Google)</p>
      <div id="firebase-auth-container"></div>
      <div class="actions">
        <button id="firebase-login-btn" class="button icon-only" type="button" aria-label="Sign in with Google">
           <svg class="icon" viewBox="0 0 24 24" aria-hidden="true">
              <path d="M7 10V7a5 5 0 0 1 10 0v3"></path>
              <rect x="4" y="10" width="16" height="10" rx="2"></rect>
           </svg>
           <span>Sign in with Google</span>
        </button>
      </div>
      
      <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";

        const firebaseConfig = {{ firebase_config | tojson }};
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        
        document.getElementById('firebase-login-btn').addEventListener('click', () => {
             const provider = new GoogleAuthProvider();
             signInWithPopup(auth, provider)
                .then((result) => {
                    const user = result.user;
                    return user.getIdToken().then(idToken => {
                        // Set cookie and redirect
                        document.cookie = `id_token=${idToken}; path=/; max-age=3600; SameSite=Lax`;
                        window.location.href = "{{ base_path }}/";
                    });
                }).catch((error) => {
                    console.error("Firebase Auth Error", error);
                    alert("Login failed: " + error.message);
                });
        });
      </script>

    {% elif login_url %}
      <p>Use {{ provider_label }} to sign in.</p>
      <div class="actions">
        <button class="button icon-only" type="button" data-href="{{ login_url }}" aria-label="Open login">
          <svg class="icon" viewBox="0 0 24 24" aria-hidden="true">
            <path d="M7 10V7a5 5 0 0 1 10 0v3"></path>
            <rect x="4" y="10" width="16" height="10" rx="2"></rect>
          </svg>
          <span class="sr-only">Open login</span>
        </button>
        {% if logout_url %}
          <button class="button ghost icon-only" type="button" data-href="{{ logout_url }}" aria-label="Logout">
            <svg class="icon" viewBox="0 0 24 24" aria-hidden="true">
              <path d="M9 16l-4-4 4-4"></path>
              <path d="M5 12h10"></path>
              <path d="M13 5h6v14h-6"></path>
            </svg>
            <span class="sr-only">Logout</span>
          </button>
        {% endif %}
      </div>
      <p class="muted">You will be redirected to /callback after login.</p>
    {% else %}
      <p>Login is not configured yet.</p>
      <p class="muted">Set provider-specific auth variables for {{ provider_label }}.</p>
    {% endif %}
    <p class="muted">API base: {{ api_base_url }}</p>
  </section>
{% endblock %}
